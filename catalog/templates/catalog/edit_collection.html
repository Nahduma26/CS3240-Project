{% extends "base.html" %}

{% block title %}Edit Collection{% endblock %}

{% block extra_styles %}
    <style>
        /* Form container */
        .add-collection-container {
            max-width: 700px;
            margin: 60px auto;
            background: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.05);
            font-family: 'Segoe UI', Roboto, sans-serif;
            color: #2c3e50;
        }
        .add-collection-container h1 {
            font-size: 1.8rem;
            margin-bottom: 24px;
            color: #2c3e50;
        }

        /* Basic field styles */
        .add-collection-container input[type="text"],
        .add-collection-container textarea,
        .add-collection-container input[type="checkbox"] {
            width: 100%;
            padding: 10px 12px;
            margin-bottom: 20px;
            border: 1px solid #dcdfe6;
            border-radius: 6px;
            font-size: 0.95rem;
            background: #f9fafe;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .add-collection-container textarea {
            resize: vertical;
            min-height: 100px;
        }
        .add-collection-container input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }
        .add-collection-container input:focus,
        .add-collection-container textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
            background: #fff;
        }

        /* Checkbox sections */
        .access-control-section {
            margin: 25px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .checkbox-section-title {
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        /* Searchable checkboxes */
        .checkbox-list {
            margin-bottom: 20px;
        }
        .checkbox-container {
            border: 1px solid #eee;
            border-radius: 6px;
            background: #f9fafe;
        }
        .checkbox-search-container {
            position: sticky;
            top: 0;
            background: #f9fafe;
            padding: 10px;
            z-index: 1;
            border-bottom: 1px solid #eee;
        }
        .checkbox-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95rem;
        }
        .checkbox-search:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
        }
        .checkbox-options {
            max-height: 200px;
            overflow-y: auto;
            padding: 0 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .checkbox-item:last-child {
            border-bottom: none;
        }
        .checkbox-item:hover {
            background: rgba(52, 152, 219, 0.05);
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 12px;
            width: auto;
            accent-color: #3498db;
        }
        .checkbox-count {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin: 8px 0 5px;
            padding: 0 2px;
        }
        .no-results {
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            display: none;
        }
        .checkbox-item.hidden {
            display: none;
        }

        /* User display styling */
        .user-display {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
        }
        .username {
            font-weight: 500;
        }
        .user-email {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-left: 5px;
        }
        .checkbox-item label {
            display: flex;
            align-items: center;
        }

        /* Submit button */
        .add-collection-container button.save-btn {
            align-self: flex-start;
            padding: 12px 24px;
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }
        .add-collection-container button.save-btn:hover {
            background: #2980b9;
        }
        .add-collection-container button.save-btn:active {
            transform: translateY(1px);
        }

        /* Cancel link */
        .add-collection-container a.cancel-link {
            display: inline-block;
            margin-top: 24px;
            font-size: 0.95rem;
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
        }
        .add-collection-container a.cancel-link:hover {
            text-decoration: underline;
        }
    </style>
{% endblock %}

{% block content %}
<div class="dashboard-container" style="max-width: 800px; margin: 50px auto; padding: 30px;">
  <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 30px; margin-bottom: 30px; border: 1px solid rgba(255, 255, 255, 0.2);">
    <h1 style="color: #fff; text-align: center; margin-bottom: 30px;">✏️ Edit Collection</h1>

    <form method="post" style="display: flex; flex-direction: column; gap: 20px;">
      {% csrf_token %}
      
      <div style="display: flex; flex-direction: column; gap: 8px;">
        <label for="title" style="color: #a5b4fc; font-size: 0.9em;">Title</label>
        <input type="text" name="title" id="title" value="{{ collection.title }}" required 
               style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; padding: 12px; border-radius: 8px; width: 100%;">
      </div>

      <div style="display: flex; flex-direction: column; gap: 8px;">
        <label for="description" style="color: #a5b4fc; font-size: 0.9em;">Description</label>
        <textarea name="description" id="description" rows="4" required
                  style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); color: #fff; padding: 12px; border-radius: 8px; width: 100%; resize: vertical;">{{ collection.description }}</textarea>
      </div>

      <div style="display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" name="is_public" id="is_public" {% if collection.is_public %}checked{% endif %}
               style="accent-color: #6366f1;">
        <label for="is_public" style="color: #a5b4fc; font-size: 0.9em;">Make this collection public</label>
      </div>

      <!-- Access Control Section -->
      <div id="access-control" style="display: none; background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
        <h3 style="color: #fff; margin-bottom: 15px;">Grant Access to Users</h3>
        <div style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2);">
          <div style="padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
            <input type="text" class="checkbox-search" placeholder="Search users by name or email..." 
                   style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #fff;">
            <div class="checkbox-count" style="color: #a5b4fc; margin-top: 10px;">
              Showing {{ form.allowed_users.field.queryset.count }} users
            </div>
          </div>
          <div class="no-results" style="padding: 20px; color: #a5b4fc; text-align: center; display: none;">
            No matching users found
          </div>
          <div class="checkbox-options" style="max-height: 200px; overflow-y: auto; padding: 15px;">
            {% for checkbox in form.allowed_users %}
              <div class="checkbox-item" data-search="{{ checkbox.choice_label|lower }}" 
                   style="padding: 10px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <label style="display: flex; align-items: center; gap: 10px; color: #fff; cursor: pointer;">
                  {{ checkbox.tag }}
                  <span>{{ checkbox.choice_label }}</span>
                </label>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Items Section -->
      <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
        <h3 style="color: #fff; margin-bottom: 15px;">Add Books to Collection</h3>
        <div style="background: rgba(255, 255, 255, 0.1); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2);">
          <div style="padding: 15px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
            <input type="text" class="checkbox-search" placeholder="Search books..." 
                   style="width: 100%; padding: 12px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; color: #fff;">
            <div class="checkbox-count" style="color: #a5b4fc; margin-top: 10px;">
              Showing {{ form.items.field.queryset.count }} books
            </div>
          </div>
          <div class="no-results" style="padding: 20px; color: #a5b4fc; text-align: center; display: none;">
            No matching books found
          </div>
          <div class="checkbox-options" style="max-height: 200px; overflow-y: auto; padding: 15px;">
            {% for checkbox in form.items %}
              <div class="checkbox-item" data-search="{{ checkbox.choice_label|lower }}" 
                   style="padding: 10px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <label style="display: flex; align-items: center; gap: 10px; color: #fff; cursor: pointer;">
                  {{ checkbox.tag }}
                  <span>{{ checkbox.choice_label }}</span>
                </label>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
        <a href="{% url 'view_collections' %}" 
           style="padding: 12px 24px; background: rgba(255, 255, 255, 0.1); color: #fff; text-decoration: none; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.2); transition: all 0.3s;">
          Cancel
        </a>
        <button type="submit" 
                style="padding: 12px 24px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: #fff; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s;">
          Save Changes
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Toggle user access control
    const isPublic = document.querySelector('#is_public');
    const accessCtl = document.querySelector('#access-control');
    function toggle() {
      accessCtl.style.display = isPublic.checked ? 'none' : 'block';
    }
    isPublic.addEventListener('change', toggle);
    toggle();

    // Search setup
    function setupSearch(inputCls, optsCls, cntCls, noCls) {
      const input = document.querySelector(`.${inputCls}`);
      const items = document.querySelectorAll(`.${optsCls} .checkbox-item`);
      const noRes = document.querySelector(`.${noCls}`);
      const count = document.querySelector(`.${cntCls}`);
      const total = items.length;
      function upd(v) { count.textContent = `Showing ${v} of ${total}`; }
      upd(total);
      input.addEventListener('input', e => {
        const term = e.target.value.toLowerCase();
        let vis = 0;
        items.forEach(i => {
          const ok = i.dataset.search.includes(term);
          i.classList.toggle('hidden', !ok);
          if (ok) vis++;
        });
        noRes.style.display = vis === 0 ? 'block' : 'none';
        upd(vis);
      });
    }
    setupSearch('users-search','users-options','users-count','users-no-results');
    setupSearch('items-search','items-options','items-count','items-no-results');
  });
</script>
{% endblock %}